import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import admin from "firebase-admin";
import { readFileSync } from "fs";

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

// ðŸ” Firebase Admin
const serviceAccount = JSON.parse(
  readFileSync("./firebase-key.json", "utf-8")
);

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

const db = admin.firestore();

/* ==============================
   RUTA DE PRUEBA
================================ */
app.get("/", (req, res) => {
  res.send("Backend funcionando correctamente ðŸš€");
});

/* ==============================
   CREAR USUARIO
================================ */
app.post("/api/usuarios", async (req, res) => {
  try {
    const { nombreUsuario, correo, password, role, activo } = req.body;

    if (!correo || !password) {
      return res.status(400).json({ message: "Correo y contraseÃ±a requeridos" });
    }

    const userRecord = await admin.auth().createUser({
      email: correo,
      password,
    });

    const uid = userRecord.uid;

    await db.collection("usuarios").doc(uid).set({
      uid,
      nombreUsuario,
      correo,
      role,
      activo,
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
    });

    res.status(201).json({ message: "Usuario creado", uid });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});

/* ==============================
   OBTENER USUARIOS
================================ */
app.get("/api/usuarios", async (req, res) => {
  try {
    const snapshot = await db.collection("usuarios").get();
    const usuarios = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    res.json(usuarios);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});

/* ==============================
   ELIMINAR USUARIO
================================ */
app.delete("/api/usuarios/:uid", async (req, res) => {
  try {
    const { uid } = req.params;
    await admin.auth().deleteUser(uid);
    await db.collection("usuarios").doc(uid).delete();
    res.json({ message: "Usuario eliminado" });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
});

/* ==============================
   SERVER
================================ */
const PORT = 3000;
app.listen(PORT, () => {
  console.log(`Servidor corriendo en http://localhost:${PORT}`);
});
